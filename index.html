<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AZADI WAR ROOM — LIVE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body,#map{width:100%;height:100%;overflow:hidden}
    body{background:#000;color:#fff;font-family:Arial}

    #topBanner{
      position:fixed;top:0;left:0;right:0;z-index:1002;
      background:#000;padding:10px;text-align:center;font-size:18px;
      border-bottom:4px solid #0f0;box-shadow:0 0 30px #0f0;color:#0f0;
    }

    #announceBox{
      position:fixed;top:52px;left:10px;right:10px;z-index:1001;
      background:rgba(0,0,0,0.92);padding:8px 10px;border-radius:10px;
      border:2px solid #0ff;box-shadow:0 0 18px #0ff;
      font-size:14px;max-height:75px;overflow-y:auto;opacity:0;
      transition:opacity 0.5s;display:none;line-height:1.4;
    }
    .ann-item{
      display:flex;justify-content:space-between;align-items:center;
      margin:4px 0;padding:6px;background:rgba(0,255,255,0.12);
      border-radius:6px;border-left:3px solid #0ff;font-size:13px;
    }
    .ann-del{
      font-size:10px;color:#f00;cursor:pointer;padding:2px 5px;
      background:rgba(255,0,0,0.2);border-radius:4px;margin-left:8px;
    }

    #panel{
      position:fixed;top:100px;left:10px;z-index:1000;
      background:rgba(0,0,0,0.92);padding:14px;border-radius:16px;
      display:none;grid-template-columns:1fr 1fr;gap:10px;
      border:3px solid #0ff;box-shadow:0 0 45px #0ff;
      font-size:14px;max-width:90vw;
    }
    button{
      padding:11px 15px;border:none;border-radius:12px;
      font-weight:bold;font-size:14px;cursor:pointer;
    }
    .green{background:#0f0;color:#000}
    .red{background:#f00}
    .gray{background:#444}
    .aqua{background:#0ff;color:#000}
    .save{background:#0f0;color:#000;grid-column:1/3;font-size:16px}
    #sizeControl{
      grid-column:1/3;background:#111;padding:12px;border-radius:12px;
      border:2px solid #0ff;box-shadow:0 0 25px #0ff;
    }
    #sizeValue{font-size:15px;color:#0ff;text-shadow:0 0 15px #0ff;margin-bottom:5px;text-align:center;}
    #sizeSlider{width:100%;height:10px;appearance:none;background:#222;border-radius:6px;}
    #sizeSlider::-webkit-slider-thumb{
      appearance:none;width:28px;height:28px;background:#0ff;border-radius:50%;
      box-shadow:0 0 22px #0ff,0 0 44px #0ff;cursor:pointer;
    }

    #legend{
      position:fixed;top:100px;right:8px;z-index:1000;
      background:rgba(0,0,0,0.9);padding:8px 10px;border-radius:10px;
      border:2px solid #0ff;box-shadow:0 0 15px #0ff;
      font-size:12px;line-height:1.6;min-width:120px;
    }
    .leg-item{display:flex;align-items:center;gap:6px;}
    .leg-ball{width:16px;height:16px;border-radius:50%;border:2px solid #fff;
      box-shadow:0 0 12px,0 0 25px;animation:glow 2s infinite;}
    @keyframes glow{50%{box-shadow:0 0 20px,0 0 40px}}

    #status{
      position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.9);
      padding:8px 14px;border-radius:10px;font-size:14px;
      border:2px solid #0f0;box-shadow:0 0 20px #0f0;
    }

    .ball{border-radius:50%;transition:all 0.3s;animation:pulse 1.5s infinite;}
    @keyframes pulse{50%{box-shadow:0 0 60px}}
    .g{background:#0f0;box-shadow:0 0 35px #0f0}
    .r{background:#f00;box-shadow:0 0 35px #f00}

    #dchowkLabel{
      position:absolute;background:rgba(0,255,255,0.3);color:#0ff;
      font-weight:bold;font-size:16px;padding:8px 14px;border-radius:10px;
      border:3px solid #0ff;box-shadow:0 0 25px #0ff,inset 0 0 15px rgba(0,255,255,0.3);
      pointer-events:none;z-index:999;display:none;text-shadow:0 0 12px #000;letter-spacing:1px;
    }
  </style>
</head>
<body>

<div id="topBanner">AZADI LIVE — <span id="modeText">WATCHING</span></div>
<div id="map"></div>

<div id="announceBox"></div>

<div id="panel">
  <button class="green" id="addG">+ PROTESTORS</button>
  <button class="red" id="addR">+ FORCES</button>
  <button class="gray" id="del">DELETE</button>
  <button class="gray" id="move">MOVE OFF</button>
  <button class="aqua" id="dchowk">SHOW D-CHOWK</button>
  
  <div id="sizeControl">
    <div id="sizeValue">BALL SIZE: 50</div>
    <input type="range" id="sizeSlider" min="0" max="100" value="50">
  </div>
  
  <button class="save" id="save">BROADCAST LIVE</button>
  <button class="gray" id="clear">CLEAR ALL</button>
  <button id="announceBtn" style="grid-column:1/3;background:#0ff;color:#000;font-size:14px;">+ ANNOUNCEMENT</button>
</div>

<div id="legend">
  <div class="leg-item"><div class="leg-ball" style="background:#0f0"></div> PROTESTORS</div>
  <div class="leg-item"><div class="leg-ball" style="background:#f00"></div> FORCES</div>
  <div class="leg-item"><div class="leg-ball" style="background:#ff8400"></div> CLASH</div>
  <div class="leg-item"><div class="leg-ball" style="background:#0ff"></div> D-CHOWK</div>
</div>

<div id="status">LOADING LIVE DATA...</div>
<div id="dchowkLabel">D-CHOWK</div>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyC0j16N6WKYbYGipY5MJeFblmyHbfQxhMc",
  authDomain: "protest2025-2437d.firebaseapp.com",
  databaseURL: "https://protest2025-2437d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "protest2025-2437d",
  storageBucket: "protest2025-2437d.firebasestorage.app",
  messagingSenderId: "987145763427",
  appId: "1:987145763427:web:109550b1fe70c5b7505656",
  measurementId: "G-960T1YLV12"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const warRoomRef = db.ref('warRoom');

maptilersdk.config.apiKey = 'DBC5HbIkYq5Exj1DeUXm';
const map = new maptilersdk.Map({
  container: 'map',
  style: '0197f1d2-6ab0-74f2-9553-26cfdbe133b5',
  center: [73.0933, 33.7292],
  zoom: 16
});

let balls = [], mode = null, dVisible = false, ballSize = 50;
let isAdmin = false, announcements = [];
const GROUP_SIZE = 4;
const ADMIN_PASSWORD = "AZADI2025";

// PASSWORD
setTimeout(() => {
  const pass = prompt("ADMIN PASSWORD (or cancel to watch):");
  if (pass === ADMIN_PASSWORD) {
    isAdmin = true;
    document.getElementById('panel').style.display = 'grid';
    document.getElementById('topBanner').innerHTML = "ADMIN MODE — FULL CONTROL";
    document.getElementById('modeText').style.color = "#0f0";
    document.getElementById('status').innerHTML = "YOU ARE IN COMMAND";
  } else {
    document.getElementById('status').innerHTML = "LIVE VIEW — REAL-TIME";
  }
}, 500);

// D-CHOWK LABEL UPDATE FUNCTION
function updateDchowkLabel() {
  const label = document.getElementById('dchowkLabel');
  if (!dVisible) {
    label.style.display = 'none';
    return;
  }
  const p = map.project([73.093, 33.7295]);
  label.style.left = (p.x - 60) + 'px';
  label.style.top = (p.y - 25) + 'px';
  label.style.display = 'block';
}

map.on('load', () => {
  map.addSource('ict', {type:'geojson', data: {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[72.855,33.495],[73.255,33.495],[73.255,33.815],[72.855,33.815],[72.855,33.495]]]}}});
  map.addLayer({id:'border',type:'line',source:'ict',paint:{'line-color':'#f00','line-width':8}});

  ['green','red','orange'].forEach(c => {
    map.addSource(c, {type:'geojson', data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:c,type:'fill',source:c,paint:{'fill-color':c==='green'?'#0f0':c==='red'?'#f00':'#ff8400','fill-opacity':0.25}});
  });

  const d = {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[73.0900,33.7315],[73.0915,33.7318],[73.0928,33.7319],[73.0942,33.7317],[73.0958,33.7312],[73.0965,33.7305],[73.0968,33.7295],[73.0965,33.7285],[73.0958,33.7278],[73.0945,33.7273],[73.0928,33.7271],[73.0912,33.7272],[73.0900,33.7275],[73.0895,33.7282],[73.0893,33.7290],[73.0895,33.7300],[73.0898,33.7308],[73.0900,33.7315]]]}};
  map.addSource('dchowk', {type:'geojson', data:d});
  map.addLayer({id:'d-outline',type:'line',source:'dchowk',paint:{'line-color':'#0ff','line-width':7}});
  map.addLayer({id:'d-fill',type:'fill',source:'dchowk',paint:{'fill-color':'#0ff','fill-opacity':0.15}});
  ['d-outline','d-fill'].forEach(l => map.setLayoutProperty(l,'visibility','none'));

  map.on('move', updateDchowkLabel);
  map.on('zoom', updateDchowkLabel);

  const t = document.createElement('script');
  t.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
  t.onload = () => {
    loadFromFirebase();
    warRoomRef.on('value', s => { const d = s.val(); if (d) loadFromFirebase(d); });
  };
  document.head.appendChild(t);
});

// BALL FUNCTIONS
function placeBall(lng, lat, type) {
  const el = document.createElement('div');
  el.className = `ball ${type==='green'?'g':'r'}`;
  setBallSize(el, ballSize);
  const m = new maptilersdk.Marker({element: el, draggable: isAdmin})
    .setLngLat([lng, lat]).addTo(map);
  m.type = type;
  m.el = el;
  if (isAdmin) {
    m.getElement().onclick = () => { if(mode==='del') { m.remove(); balls = balls.filter(x=>x!==m); broadcast(); }};
    m.on('dragend', broadcast);
  }
  balls.push(m);
}

function setBallSize(el, size) {
  const px = Math.max(6, 6 + (size * 1.2));
  el.style.width = el.style.height = px + 'px';
  el.style.opacity = size > 0 ? '1' : '0';
  el.style.boxShadow = size > 0 
    ? (el.classList.contains('g') ? `0 0 ${25 + size}px #0f0` : `0 0 ${25 + size}px #f00`)
    : 'none';
}

function updateAllBallSizes() { balls.forEach(m => setBallSize(m.el, ballSize)); }

function updateZones() {
  const greens = balls.filter(b=>b.type==='green');
  const reds = balls.filter(b=>b.type==='red');
  const greenGroups = chunk(greens);
  const redGroups = chunk(reds);
  const zones = [];

  greenGroups.forEach(g => { const h=makeHull(g); if(h){h.properties={color:'green'}; zones.push(h);} });
  redGroups.forEach(r => { const h=makeHull(r); if(h){h.properties={color:'red'}; zones.push(h);} });
  greenGroups.forEach(g => redGroups.forEach(r => {
    const i = turf.intersect(makeHull(g), makeHull(r));
    if(i){i.properties={color:'orange'}; zones.push(i);}
  }));

  ['green','red','orange'].forEach(c => {
    map.getSource(c).setData({type:'FeatureCollection', features: zones.filter(z=>z.properties.color===c)});
  });
}

function chunk(arr) {
  const res = [];
  for (let i = 0; i < arr.length; i += GROUP_SIZE) res.push(arr.slice(i, i + GROUP_SIZE));
  return res;
}

function makeHull(group) {
  if (group.length < 2) return null;
  return turf.convex(turf.featureCollection(group.map(b=>turf.point([b.getLngLat().lng, b.getLngLat().lat]))));
}

// BROADCAST & LOAD
function broadcast() {
  if (!isAdmin) return;
  const data = {
    balls: balls.map(b=>({lng:b.getLngLat().lng, lat:b.getLngLat().lat, type:b.type})),
    size: ballSize,
    dVisible,
    announcements,
    timestamp: Date.now()
  };
  warRoomRef.set(data).then(() => {
    document.getElementById('status').innerHTML = `LIVE — ${balls.length} UNITS`;
  }).catch(() => alert("Sync failed! Check internet or Firebase rules."));
}

function loadFromFirebase(data) {
  balls.forEach(b => b.remove()); balls = [];
  if (!data) { document.getElementById('status').innerHTML = "NO DATA YET"; return; }

  data.balls.forEach(b => placeBall(b.lng, b.lat, b.type));
  ballSize = data.size || 50;
  dVisible = data.dVisible || false;
  announcements = data.announcements || [];

  if (isAdmin) {
    document.getElementById('sizeSlider').value = ballSize;
    document.getElementById('sizeValue').innerHTML = `BALL SIZE: ${ballSize}`;
  }
  updateAllBallSizes();
  updateZones();

  // D-CHOWK VISIBILITY
  const vis = dVisible ? 'visible' : 'none';
  ['d-outline','d-fill'].forEach(l => map.setLayoutProperty(l,'visibility', vis));
  updateDchowkLabel();  // FIXED: NOW CALLS THE FUNCTION

  showAnnouncements();  // FIXED: ALWAYS REFRESH ANNOUNCEMENTS

  if (!isAdmin) document.getElementById('status').innerHTML = `LIVE: ${data.balls.length} UNITS`;
}

// ANNOUNCEMENTS — NOW FULLY WORKING
function showAnnouncements() {
  const box = document.getElementById('announceBox');
  box.innerHTML = '';
  if (announcements.length === 0) {
    box.style.display = 'none';
    box.style.opacity = 0;
    return;
  }

  announcements.forEach((a, i) => {
    const div = document.createElement('div');
    div.className = 'ann-item';
    div.innerHTML = `<div class="ann-text">${a}</div>`;
    if (isAdmin) {
      const del = document.createElement('div');
      del.className = 'ann-del';
      del.textContent = 'X';
      del.onclick = () => {
        announcements.splice(i, 1);
        broadcast();
        showAnnouncements();  // Refresh instantly
      };
      div.appendChild(del);
    }
    box.appendChild(div);
  });

  box.style.display = 'block';
  setTimeout(() => box.style.opacity = 1, 50);
}

// ADMIN CONTROLS
document.getElementById('addG').onclick = () => { if(isAdmin) mode='green'; };
document.getElementById('addR').onclick = () => { if(isAdmin) mode='red'; };
document.getElementById('del').onclick = () => { if(isAdmin) mode='del'; };
document.getElementById('move').onclick = () => {
  if(!isAdmin) return;
  const on = document.getElementById('move').textContent.includes('OFF');
  document.getElementById('move').textContent = on ? 'MOVE ON' : 'MOVE OFF';
  balls.forEach(b=>b.setDraggable(on));
};
document.getElementById('dchowk').onclick = () => {
  if(!isAdmin) return;
  dVisible = !dVisible;
  document.getElementById('dchowk').textContent = dVisible ? 'HIDE D-CHOWK' : 'SHOW D-CHOWK';
  broadcast();
};
document.getElementById('sizeSlider').oninput = function() {
  if(!isAdmin) return;
  ballSize = this.value;
  document.getElementById('sizeValue').innerHTML = `BALL SIZE: ${ballSize}`;
  updateAllBallSizes();
  broadcast();
};
document.getElementById('save').onclick = broadcast;
document.getElementById('clear').onclick = () => {
  if(!isAdmin || !confirm('ERASE ALL?')) return;
  balls.forEach(b=>b.remove()); balls=[]; announcements=[];
  warRoomRef.remove().then(() => document.getElementById('status').innerHTML = "CLEARED");
};
document.getElementById('announceBtn').onclick = () => {
  if(!isAdmin) return;
  const msg = prompt("ANNOUNCEMENT:");
  if(msg && msg.trim()) {
    announcements.unshift(msg.trim());
    if(announcements.length > 8) announcements.pop();
    broadcast();
    showAnnouncements();  // Show instantly
  }
};

map.on('click', e => {
  if(!isAdmin || !mode || mode==='del') return;
  placeBall(e.lngLat.lng, e.lngLat.lat, mode);
  broadcast();
});
</script>
</body>
</html>
