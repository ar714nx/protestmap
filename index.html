<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AZADI 4-BALL GROUPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.0/maptiler-sdk.umd.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.0/maptiler-sdk.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:Arial;overflow:hidden}
    #map{width:100vw;height:100vh}
    
    #panel{
      position:fixed;top:10px;left:10px;z-index:1000;
      background:rgba(0,0,0,0.9);padding:18px;border-radius:18px;
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
      border:4px solid #0ff;box-shadow:0 0 50px #0ff;
    }
    button{
      padding:16px 22px;border:none;border-radius:14px;
      font-weight:bold;font-size:17px;cursor:pointer;
      box-shadow:0 5px 20px rgba(0,0,0,0.7);
    }
    .green{background:#0f0;color:#000}
    .red{background:#f00}
    .gray{background:#444}
    .aqua{background:#0ff;color:#000}
    .save{background:#0f0;color:#000;grid-column:1/3;font-size:19px}
    
    /* LEGEND — GLOWING & FIXED */
    #legend{
      position:fixed;top:170px;right:15px;z-index:1000;
      background:rgba(0,0,0,0.95);padding:20px 25px;
      border-radius:18px;border:4px solid #0ff;
      box-shadow:0 0 50px #0ff, inset 0 0 25px #000;
      font-weight:bold;font-size:18px;line-height:2.5;
      backdrop-filter:blur(12px);min-width:200px;
    }
    .leg-item{display:flex;align-items:center;gap:14px}
    .leg-ball{
      width:28px;height:28px;border-radius:50%;
      border:3px solid #fff;box-shadow:0 0 30px;
      flex-shrink:0;
    }
    
    #status{
      position:fixed;bottom:15px;left:15px;
      background:rgba(0,0,0,0.9);padding:14px 25px;
      border-radius:14px;font-size:17px;
      border:3px solid #0f0;box-shadow:0 0 30px #0f0;
    }
    
    .ball{width:42px;height:42px;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{50%{box-shadow:0 0 80px}}
    .g{background:#0f0;box-shadow:0 0 45px #0f0}
    .r{background:#f00;box-shadow:0 0 45px #f00}
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <button class="green" id="addG">+ GREEN</button>
  <button class="red" id="addR">+ RED</button>
  <button class="gray" id="del">DELETE</button>
  <button class="gray" id="move">MOVE OFF</button>
  <button class="aqua" id="dchowk">SHOW D-CHOWK</button>
  <button class="save" id="save">SAVE MAP</button>
  <button class="gray" id="clear">CLEAR ALL</button>
</div>

<div id="legend">
  <div class="leg-item"><div class="leg-ball" style="background:#0f0"></div> PTI (4 = 1 GROUP)</div>
  <div class="leg-item"><div class="leg-ball" style="background:#f00"></div> POLICE (4 = 1 GROUP)</div>
  <div class="leg-item"><div class="leg-ball" style="background:#ff8400"></div> CLASH ZONE</div>
  <div class="leg-item"><div class="leg-ball" style="background:#0ff"></div> D-CHOWK HQ</div>
</div>

<div id="status">4 BALLS = 1 GROUP — SAVE FIXED</div>

<script>
maptilersdk.config.apiKey = 'DBC5HbIkYq5Exj1DeUXm';
const map = new maptilersdk.Map({
  container: 'map',
  style: '0197f1d2-6ab0-74f2-9553-26cfdbe133b5',
  center: [73.0933, 33.7292],
  zoom: 16
});

let balls = [], mode = null, dVisible = false;
const GROUP_SIZE = 4;

// D-CHOWK
const dchowk = {"type":"Feature","properties":{"name":"D-CHOWK"},"geometry":{"type":"Polygon","coordinates":[[[73.0900,33.7315],[73.0915,33.7318],[73.0928,33.7319],[73.0942,33.7317],[73.0958,33.7312],[73.0965,33.7305],[73.0968,33.7295],[73.0965,33.7285],[73.0958,33.7278],[73.0945,33.7273],[73.0928,33.7271],[73.0912,33.7272],[73.0900,33.7275],[73.0895,33.7282],[73.0893,33.7290],[73.0895,33.7300],[73.0898,33.7308],[73.0900,33.7315]]]}};

map.on('load', () => {
  // RED BORDER
  map.addSource('ict', {type:'geojson', data: {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[72.855,33.495],[73.255,33.495],[73.255,33.815],[72.855,33.815],[72.855,33.495]]]}}});
  map.addLayer({id:'border',type:'line',source:'ict',paint:{'line-color':'#f00','line-width':10}});

  // ZONES
  ['green','red','orange'].forEach(c => {
    map.addSource(c, {type:'geojson', data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:c,type:'fill',source:c,paint:{'fill-color':c==='green'?'#0f0':c==='red'?'#f00':'#ff8400','fill-opacity':0.25}});
  });

  // D-CHOWK
  map.addSource('dchowk', {type:'geojson', data:dchowk});
  map.addLayer({id:'d-outline',type:'line',source:'dchowk',paint:{'line-color':'#0ff','line-width':8}});
  map.addLayer({id:'d-fill',type:'fill',source:'dchowk',paint:{'fill-color':'#0ff','fill-opacity':0.1}});
  map.addLayer({id:'d-label',type:'symbol',source:'dchowk',layout:{'text-field':'D-CHOWK','text-size':28},paint:{'text-color':'#0ff','text-halo-color':'#000','text-halo-width':5}});
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility','none'));

  // TURF + AUTO LOAD
  const t = document.createElement('script');
  t.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
  t.onload = () => {
    console.log("Turf loaded");
    loadSavedBalls(); // FIXED: LOADS ON START
  };
  document.head.appendChild(t);
});

function placeBall(lng, lat, type) {
  const el = document.createElement('div');
  el.className = `ball ${type==='green'?'g':'r'}`;
  const m = new maptilersdk.Marker({element: el, draggable: true})
    .setLngLat([lng, lat]).addTo(map);
  m.type = type;
  m.getElement().onclick = () => { if(mode==='del'){ m.remove(); balls = balls.filter(x=>x!==m); updateZones(); saveBalls(); }};
  m.on('dragend', () => { updateZones(); saveBalls(); });
  balls.push(m);
  updateZones();
}

// 4 BALLS = 1 GROUP
function updateZones() {
  const greens = balls.filter(b=>b.type==='green');
  const reds = balls.filter(b=>b.type==='red');

  const greenGroups = chunkArray(greens, GROUP_SIZE);
  const redGroups = chunkArray(reds, GROUP_SIZE);

  const greenHulls = greenGroups.map(g => makeHull(g)).filter(Boolean);
  const redHulls = redGroups.map(g => makeHull(g)).filter(Boolean);

  map.getSource('green').setData({type:'FeatureCollection', features: greenHulls});
  map.getSource('red').setData({type:'FeatureCollection', features: redHulls});

  const clashes = [];
  greenHulls.forEach(g => {
    redHulls.forEach(r => {
      const inter = turf.intersect(g, r);
      if (inter) clashes.push(inter);
    });
  });
  map.getSource('orange').setData({type:'FeatureCollection', features: clashes});
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) {
    chunks.push(arr.slice(i, i + size));
  }
  return chunks;
}

function makeHull(group) {
  if (group.length < 2) return null;
  const pts = group.map(b => turf.point([b.getLngLat().lng, b.getLngLat().lat]));
  return turf.convex(turf.featureCollection(pts));
}

// SAVE — FIXED 100%
function saveBalls() {
  const data = balls.map(b => ({
    lng: b.getLngLat().lng,
    lat: b.getLngLat().lat,
    type: b.type
  }));
  localStorage.setItem('AZADI_4BALL_FINAL', JSON.stringify(data));
  const greenGroups = Math.ceil(balls.filter(b=>b.type==='green').length / GROUP_SIZE);
  const redGroups = Math.ceil(balls.filter(b=>b.type==='red').length / GROUP_SIZE);
  document.getElementById('status').innerHTML = `SAVED ${balls.length} BALLS | ${greenGroups} PTI + ${redGroups} POLICE GROUPS`;
}

// LOAD — FIXED 100%
function loadSavedBalls() {
  const saved = localStorage.getItem('AZADI_4BALL_FINAL');
  if (!saved) {
    document.getElementById('status').innerHTML = 'NO SAVE YET — START FRESH';
    return;
  }
  const data = JSON.parse(saved);
  balls.forEach(b => b.remove());
  balls = [];
  data.forEach(b => placeBall(b.lng, b.lat, b.type));
  const greenGroups = Math.ceil(data.filter(b=>b.type==='green').length / GROUP_SIZE);
  const redGroups = Math.ceil(data.filter(b=>b.type==='red').length / GROUP_SIZE);
  document.getElementById('status').innerHTML = `LOADED ${data.length} BALLS | ${greenGroups} PTI + ${redGroups} POLICE GROUPS`;
}

// BUTTONS
document.getElementById('addG').onclick = () => { mode='green'; document.getElementById('status').innerHTML='TAP → ADD TO PTI GROUP'; };
document.getElementById('addR').onclick = () => { mode='red'; document.getElementById('status').innerHTML='TAP → ADD TO POLICE GROUP'; };
document.getElementById('del').onclick = () => { mode='del'; document.getElementById('status').innerHTML='TAP BALL → DELETE'; };
document.getElementById('move').onclick = () => {
  const on = document.getElementById('move').textContent.includes('OFF');
  document.getElementById('move').textContent = on ? 'MOVE ON' : 'MOVE OFF';
  balls.forEach(b => b.setDraggable(on));
};
document.getElementById('dchowk').onclick = () => {
  dVisible = !dVisible;
  const v = dVisible ? 'visible' : 'none';
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility',v));
  document.getElementById('dchowk').textContent = dVisible ? 'HIDE D-CHOWK' : 'SHOW D-CHOWK';
};
document.getElementById('save').onclick = saveBalls;
document.getElementById('clear').onclick = () => {
  if(confirm('WIPE ALL GROUPS?')) {
    balls.forEach(b=>b.remove()); balls=[]; updateZones();
    localStorage.removeItem('AZADI_4BALL_FINAL');
    document.getElementById('status').innerHTML = 'MAP CLEARED — START AGAIN';
  }
};

map.on('click', e => {
  if(!mode || mode==='del') return;
  placeBall(e.lngLat.lng, e.lngLat.lat, mode);
  saveBalls();
});
</script>
</body>
</html>
