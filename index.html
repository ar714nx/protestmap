<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AZADI PERFECT SIZE + SAVE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body,#map{width:100%;height:100%;overflow:hidden}
    body{background:#000;color:#fff;font-family:Arial}
    
    #panel{
      position:fixed;top:10px;left:10px;z-index:1000;
      background:rgba(0,0,0,0.9);padding:18px;border-radius:18px;
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
      border:4px solid #0ff;box-shadow:0 0 50px #0ff;
    }
    button{
      padding:16px 22px;border:none;border-radius:14px;
      font-weight:bold;font-size:17px;cursor:pointer;
    }
    .green{background:#0f0;color:#000}
    .red{background:#f00}
    .gray{background:#444}
    .aqua{background:#0ff;color:#000}
    .save{background:#0f0;color:#000;grid-column:1/3;font-size:19px}
    
    /* SIZE SLIDER — GLOWING */
    #sizeControl{
      grid-column:1/3;background:#111;padding:15px;border-radius:14px;
      border:3px solid #0ff;box-shadow:0 0 40px #0ff;
    }
    #sizeSlider{
      width:100%;height:14px;appearance:none;background:#222;
      outline:none;border-radius:10px;
      box-shadow:inset 0 0 20px #000;
    }
    #sizeSlider::-webkit-slider-thumb{
      appearance:none;width:34px;height:34px;
      background:#0ff;border-radius:50%;cursor:pointer;
      box-shadow:0 0 30px #0ff, 0 0 60px #0ff;
    }
    #sizeValue{
      text-align:center;margin-top:8px;font-size:19px;font-weight:bold;
      color:#0ff;text-shadow:0 0 20px #0ff;
    }
    
    /* INDICATORS — FIXED & GLOWING */
    #legend{
      position:fixed;top:170px;right:15px;z-index:1000;
      background:rgba(0,0,0,0.95);padding:22px 28px;
      border-radius:20px;border:4px solid #0ff;
      box-shadow:0 0 60px #0ff, inset 0 0 30px #000;
      font-weight:bold;font-size:19px;line-height:2.6;
      backdrop-filter:blur(14px);min-width:220px;
    }
    .leg-item{display:flex;align-items:center;gap:16px;margin:8px 0}
    .leg-ball{
      width:32px;height:32px;border-radius:50%;
      border:4px solid #fff;box-shadow:0 0 40px, 0 0 80px;
      flex-shrink:0;animation:glow 2s infinite;
    }
    @keyframes glow{50%{box-shadow:0 0 60px, 0 0 100px}}
    
    #status{
      position:fixed;bottom:15px;left:15px;
      background:rgba(0,0,0,0.9);padding:16px 28px;
      border-radius:16px;font-size:18px;
      border:3px solid #0f0;box-shadow:0 0 40px #0f0;
      text-shadow:0 0 15px #0f0;
    }
    
    .ball{
      border-radius:50%;transition:all 0.3s ease;
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse{50%{box-shadow:0 0 90px}}
    .g{background:#0f0;box-shadow:0 0 50px #0f0}
    .r{background:#f00;box-shadow:0 0 50px #f00}
  </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <button class="green" id="addG">+ GREEN</button>
  <button class="red" id="addR">+ RED</button>
  <button class="gray" id="del">DELETE</button>
  <button class="gray" id="move">MOVE OFF</button>
  <button class="aqua" id="dchowk">SHOW D-CHOWK</button>
  
  <div id="sizeControl">
    <div id="sizeValue">BALL SIZE: 50</div>
    <input type="range" id="sizeSlider" min="0" max="100" value="50">
  </div>
  
  <button class="save" id="save">SAVE MAP</button>
  <button class="gray" id="clear">CLEAR ALL</button>
</div>

<div id="legend">
  <div class="leg-item"><div class="leg-ball" style="background:#0f0"></div> PTI ARMY</div>
  <div class="leg-item"><div class="leg-ball" style="background:#f00"></div> POLICE</div>
  <div class="leg-item"><div class="leg-ball" style="background:#ff8400"></div> CLASH ZONE</div>
  <div class="leg-item"><div class="leg-ball" style="background:#0ff"></div> D-CHOWK HQ</div>
</div>

<div id="status">SIZE + SAVE FIXED — SLIDE NOW</div>

<script>
maptilersdk.config.apiKey = 'DBC5HbIkYq5Exj1DeUXm';
const map = new maptilersdk.Map({
  container: 'map',
  style: '0197f1d2-6ab0-74f2-9553-26cfdbe133b5',
  center: [73.0933, 33.7292],
  zoom: 16
});

let balls = [], mode = null, dVisible = false;
const GROUP_SIZE = 4;
let ballSize = 50;

// APPLY SIZE TO BALL
function setBallSize(el, size) {
  const px = Math.max(8, 8 + (size * 1.4)); // 8px → 148px
  el.style.width = px + 'px';
  el.style.height = px + 'px';
  el.style.opacity = size > 0 ? '1' : '0';
  el.style.boxShadow = size > 0 
    ? (el.classList.contains('g') 
        ? `0 0 ${30 + size}px #0f0` 
        : `0 0 ${30 + size}px #f00`)
    : 'none';
}

function placeBall(lng, lat, type) {
  const el = document.createElement('div');
  el.className = `ball ${type==='green'?'g':'r'}`;
  setBallSize(el, ballSize);
  
  const m = new maptilersdk.Marker({element: el, draggable: true})
    .setLngLat([lng, lat]).addTo(map);
  m.type = type;
  m.el = el;
  
  m.getElement().onclick = () => { 
    if(mode==='del'){ m.remove(); balls = balls.filter(x=>x!==m); updateZones(); saveBalls(); }
  };
  m.on('dragend', () => { updateZones(); saveBalls(); });
  balls.push(m);
  updateZones();
}

function updateAllBallSizes() {
  balls.forEach(m => setBallSize(m.el, ballSize));
}

// SLIDER
document.getElementById('sizeSlider').oninput = function() {
  ballSize = parseInt(this.value);
  document.getElementById('sizeValue').innerHTML = `BALL SIZE: ${ballSize}`;
  updateAllBallSizes();
  saveBalls();
};

// ZONES
function updateZones() {
  const greens = balls.filter(b=>b.type==='green');
  const reds = balls.filter(b=>b.type==='red');
  const greenGroups = chunkArray(greens, GROUP_SIZE);
  const redGroups = chunkArray(reds, GROUP_SIZE);
  const greenHulls = greenGroups.map(g => makeHull(g)).filter(Boolean);
  const redHulls = redGroups.map(g => makeHull(g)).filter(Boolean);

  map.getSource('green').setData({type:'FeatureCollection', features: greenHulls});
  map.getSource('red').setData({type:'FeatureCollection', features: redHulls});

  const clashes = [];
  greenHulls.forEach(g => redHulls.forEach(r => {
    const inter = turf.intersect(g, r);
    if (inter) clashes.push(inter);
  }));
  map.getSource('orange').setData({type:'FeatureCollection', features: clashes});
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
  return chunks;
}

function makeHull(group) {
  if (group.length < 2) return null;
  const pts = group.map(b => turf.point([b.getLngLat().lng, b.getLngLat().lat]));
  return turf.convex(turf.featureCollection(pts));
}

// SAVE — NOW 100% FIXED
function saveBalls() {
  const data = balls.map(b => ({
    lng: b.getLngLat().lng,
    lat: b.getLngLat().lat,
    type: b.type
  }));
  const saveData = {balls: data, size: ballSize};
  localStorage.setItem('AZADI_PERFECT', JSON.stringify(saveData));
  document.getElementById('status').innerHTML = `SAVED | SIZE: ${ballSize}`;
}

// LOAD — PERFECT
function loadSavedBalls() {
  const saved = localStorage.getItem('AZADI_PERFECT');
  if (!saved) { 
    document.getElementById('status').innerHTML = 'FRESH MAP'; 
    return; 
  }
  const data = JSON.parse(saved);
  balls.forEach(b => b.remove()); 
  balls = [];
  
  data.balls.forEach(b => placeBall(b.lng, b.lat, b.type));
  
  ballSize = data.size || 50;
  document.getElementById('sizeSlider').value = ballSize;
  document.getElementById('sizeValue').innerHTML = `BALL SIZE: ${ballSize}`;
  updateAllBallSizes();
  
  document.getElementById('status').innerHTML = `LOADED ${data.balls.length} BALLS | SIZE: ${ballSize}`;
}

map.on('load', () => {
  map.addSource('ict', {type:'geojson', data: {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[72.855,33.495],[73.255,33.495],[73.255,33.815],[72.855,33.815],[72.855,33.495]]]}}});
  map.addLayer({id:'border',type:'line',source:'ict',paint:{'line-color':'#f00','line-width':10}});

  ['green','red','orange'].forEach(c => {
    map.addSource(c, {type:'geojson', data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:c,type:'fill',source:c,paint:{'fill-color':c==='green'?'#0f0':c==='red'?'#f00':'#ff8400','fill-opacity':0.25}});
  });

  const dchowk = {"type":"Feature","properties":{"name":"D-CHOWK"},"geometry":{"type":"Polygon","coordinates":[[[73.0900,33.7315],[73.0915,33.7318],[73.0928,33.7319],[73.0942,33.7317],[73.0958,33.7312],[73.0965,33.7305],[73.0968,33.7295],[73.0965,33.7285],[73.0958,33.7278],[73.0945,33.7273],[73.0928,33.7271],[73.0912,33.7272],[73.0900,33.7275],[73.0895,33.7282],[73.0893,33.7290],[73.0895,33.7300],[73.0898,33.7308],[73.0900,33.7315]]]}};
  map.addSource('dchowk', {type:'geojson', data:dchowk});
  map.addLayer({id:'d-outline',type:'line',source:'dchowk',paint:{'line-color':'#0ff','line-width':8}});
  map.addLayer({id:'d-fill',type:'fill',source:'dchowk',paint:{'fill-color':'#0ff','fill-opacity':0.1}});
  map.addLayer({id:'d-label',type:'symbol',source:'dchowk',layout:{'text-field':'D-CHOWK','text-size':28},paint:{'text-color':'#0ff','text-halo-color':'#000','text-halo-width':5}});
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility','none'));

  const t = document.createElement('script');
  t.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
  t.onload = () => loadSavedBalls();
  document.head.appendChild(t);
});

// BUTTONS
document.getElementById('addG').onclick = () => { mode='green'; document.getElementById('status').innerHTML='TAP → PTI'; };
document.getElementById('addR').onclick = () => { mode='red'; document.getElementById('status').innerHTML='TAP → POLICE'; };
document.getElementById('del').onclick = () => { mode='del'; document.getElementById('status').innerHTML='TAP BALL → DELETE'; };
document.getElementById('move').onclick = () => {
  const on = document.getElementById('move').textContent.includes('OFF');
  document.getElementById('move').textContent = on ? 'MOVE ON' : 'MOVE OFF';
  balls.forEach(b => b.setDraggable(on));
};
document.getElementById('dchowk').onclick = () => {
  dVisible = !dVisible;
  const v = dVisible ? 'visible' : 'none';
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility',v));
  document.getElementById('dchowk').textContent = dVisible ? 'HIDE D-CHOWK' : 'SHOW D-CHOWK';
};
document.getElementById('save').onclick = saveBalls;
document.getElementById('clear').onclick = () => {
  if(confirm('WIPE ALL?')) {
    balls.forEach(b=>b.remove()); balls=[]; updateZones();
    localStorage.removeItem('AZADI_PERFECT');
    ballSize = 50;
    document.getElementById('sizeSlider').value = 50;
    document.getElementById('sizeValue').innerHTML = 'BALL SIZE: 50';
    document.getElementById('status').innerHTML = 'CLEARED';
  }
};

map.on('click', e => {
  if(!mode || mode==='del') return;
  placeBall(e.lngLat.lng, e.lngLat.lat, mode);
  saveBalls();
});
</script>
</body>
</html>
