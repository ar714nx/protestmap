<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AZADI WAR MAP - SAVE FIXED</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.0/maptiler-sdk.umd.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.0/maptiler-sdk.css" rel="stylesheet"/>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:Arial;overflow:hidden}
    #map{width:100vw;height:100vh}
    .panel{position:fixed;top:10px;left:10px;z-index:1000;background:rgba(0,0,0,0.9);padding:15px;border-radius:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:14px 20px;border:none;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer}
    .green{background:#0f0;color:#000}.red{background:#f00}.gray{background:#444}.aqua{background:#0ff;color:#000}
    .save{background:#0f0;color:#000;grid-column:1/3}
    #status{position:fixed;bottom:15px;left:15px;background:rgba(0,0,0,0.8);padding:12px 20px;border-radius:12px;font-size:16px}
    .ball{width:38px;height:38px;border-radius:50%;box-shadow:0 0 40px;animation:pulse 1.5s infinite}
    @keyframes pulse{50%{box-shadow:0 0 70px}}
    .g{background:#0f0;box-shadow:0 0 40px #0f0}.r{background:#f00;box-shadow:0 0 40px #f00}
  </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <button class="green" id="addG">+ GREEN</button>
  <button class="red" id="addR">+ RED</button>
  <button class="gray" id="del">DELETE</button>
  <button class="gray" id="move">MOVE OFF</button>
  <button class="aqua" id="dchowk">SHOW D-CHOWK</button>
  <button class="save" id="save">SAVE MAP</button>
  <button class="gray" id="clear">CLEAR ALL</button>
</div>

<div id="status">SAVE FIXED — YOUR BALLS ARE SAFE</div>

<script>
maptilersdk.config.apiKey = 'DBC5HbIkYq5Exj1DeUXm';
const map = new maptilersdk.Map({
  container: 'map',
  style: '0197f1d2-6ab0-74f2-9553-26cfdbe133b5',
  center: [73.0933, 33.7292],
  zoom: 16
});

let balls = [];
let mode = null;
let dVisible = false;

// D-CHOWK
const dchowk = {"type":"Feature","properties":{"name":"D-CHOWK"},"geometry":{"type":"Polygon","coordinates":[[[73.0900,33.7315],[73.0915,33.7318],[73.0928,33.7319],[73.0942,33.7317],[73.0958,33.7312],[73.0965,33.7305],[73.0968,33.7295],[73.0965,33.7285],[73.0958,33.7278],[73.0945,33.7273],[73.0928,33.7271],[73.0912,33.7272],[73.0900,33.7275],[73.0895,33.7282],[73.0893,33.7290],[73.0895,33.7300],[73.0898,33.7308],[73.0900,33.7315]]]}};

map.on('load', () => {
  // RED BORDER
  map.addSource('ict', {type:'geojson', data: {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[72.855,33.495],[73.255,33.495],[73.255,33.815],[72.855,33.815],[72.855,33.495]]]}}});
  map.addLayer({id:'border',type:'line',source:'ict',paint:{'line-color':'#f00','line-width':9}});

  // ZONES
  ['green','red','orange'].forEach(c => {
    map.addSource(c, {type:'geojson', data:{type:'FeatureCollection',features:[]}});
    map.addLayer({id:c,type:'fill',source:c,paint:{'fill-color':c==='green'?'#0f0':c==='red'?'#f00':'#ff8400','fill-opacity':0.2}});
  });

  // D-CHOWK
  map.addSource('dchowk', {type:'geojson', data:dchowk});
  map.addLayer({id:'d-outline',type:'line',source:'dchowk',paint:{'line-color':'#0ff','line-width':7}});
  map.addLayer({id:'d-fill',type:'fill',source:'dchowk',paint:{'fill-color':'#0ff','fill-opacity':0.08}});
  map.addLayer({id:'d-label',type:'symbol',source:'dchowk',layout:{'text-field':'D-CHOWK','text-size':24},paint:{'text-color':'#0ff','text-halo-color':'#000','text-halo-width':3}});
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility','none'));

  // TURF
  const turf = document.createElement('script');
  turf.src = 'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js';
  turf.onload = () => {
    console.log("Turf loaded");
    loadSavedBalls(); // FIXED: LOAD ON START
  };
  document.head.appendChild(turf);
});

function placeBall(lng, lat, type) {
  const el = document.createElement('div');
  el.className = `ball ${type==='green'?'g':'r'}`;
  
  const marker = new maptilersdk.Marker({element: el, draggable: true})
    .setLngLat([lng, lat])
    .addTo(map);
  
  marker.type = type;
  marker.getElement().onclick = () => { if(mode==='del'){ marker.remove(); balls=balls.filter(m=>m!==marker); updateZones(); saveBalls(); }};
  marker.on('dragend', () => { updateZones(); saveBalls(); });
  balls.push(marker);
  updateZones();
}

function updateZones() {
  const greens = balls.filter(b=>b.type==='green').map(b=>turf.point([b.getLngLat().lng, b.getLngLat().lat]));
  const reds = balls.filter(b=>b.type==='red').map(b=>turf.point([b.getLngLat().lng, b.getLngLat().lat]));

  const gPoly = greens.length >= 2 ? turf.convex(turf.featureCollection(greens)) : null;
  const rPoly = reds.length >= 2 ? turf.convex(turf.featureCollection(reds)) : null;

  map.getSource('green').setData(gPoly ? {type:'FeatureCollection',features:[gPoly]} : {type:'FeatureCollection',features:[]});
  map.getSource('red').setData(rPoly ? {type:'FeatureCollection',features:[rPoly]} : {type:'FeatureCollection',features:[]});
  map.getSource('orange').setData(gPoly && rPoly && turf.intersect(gPoly,rPoly) ? 
    {type:'FeatureCollection',features:[turf.intersect(gPoly,rPoly)]} : 
    {type:'FeatureCollection',features:[]});
}

// FIXED: SAVE EVERY CHANGE
function saveBalls() {
  const data = balls.map(b => ({
    lng: b.getLngLat().lng,
    lat: b.getLngLat().lat,
    type: b.type
  }));
  localStorage.setItem('AZADI_BALLS', JSON.stringify(data));
  document.getElementById('status').innerHTML = 'SAVED';
}

// FIXED: LOAD ON START
function loadSavedBalls() {
  const saved = localStorage.getItem('AZADI_BALLS');
  if (!saved) {
    document.getElementById('status').innerHTML = 'NO SAVE YET';
    return;
  }
  const data = JSON.parse(saved);
  balls.forEach(b => b.remove());
  balls = [];
  data.forEach(b => placeBall(b.lng, b.lat, b.type));
  document.getElementById('status').innerHTML = `LOADED ${data.length} BALLS`;
}

// BUTTONS
document.getElementById('addG').onclick = () => { mode='green'; document.getElementById('status').innerHTML='TAP MAP → GREEN'; };
document.getElementById('addR').onclick = () => { mode='red'; document.getElementById('status').innerHTML='TAP MAP → RED'; };
document.getElementById('del').onclick = () => { mode='del'; document.getElementById('status').innerHTML='TAP BALL → DELETE'; };
document.getElementById('move').onclick = () => {
  const on = document.getElementById('move').textContent.includes('OFF');
  document.getElementById('move').textContent = on ? 'MOVE ON' : 'MOVE OFF';
  balls.forEach(b => b.setDraggable(on));
};
document.getElementById('dchowk').onclick = () => {
  dVisible = !dVisible;
  const v = dVisible ? 'visible' : 'none';
  ['d-outline','d-fill','d-label'].forEach(l => map.setLayoutProperty(l,'visibility',v));
  document.getElementById('dchowk').textContent = dVisible ? 'HIDE D-CHOWK' : 'SHOW D-CHOWK';
};
document.getElementById('save').onclick = () => { saveBalls(); };
document.getElementById('clear').onclick = () => {
  if(confirm('NUKE ALL BALLS?')) {
    balls.forEach(b=>b.remove());
    balls = [];
    updateZones();
    localStorage.removeItem('AZADI_BALLS');
    document.getElementById('status').innerHTML = 'CLEARED';
  }
};

// TAP TO PLACE
map.on('click', e => {
  if(!mode || mode==='del') return;
  placeBall(e.lngLat.lng, e.lngLat.lat, mode);
  saveBalls(); // AUTO-SAVE
});
</script>
</body>
</html>
